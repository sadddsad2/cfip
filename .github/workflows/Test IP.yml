name: Test IP Connectivity and Create Release

on:
  schedule:
    - cron: '0 19 * * *'  # æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨3ç‚¹è¿è¡Œ (UTC 19:00 = åŒ—äº¬æ—¶é—´ 03:00)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches:
      - main
    paths:
      - '.github/workflows/ip-test.yml'
      - 'api.txt'
      - 'test_ip.py'

# æ·»åŠ å¿…è¦çš„æƒé™
permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶
  actions: read

jobs:
  test-and-release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        pip install requests aiohttp asyncio dnspython beautifulsoup4 lxml

    - name: Verify api.txt exists
      run: |
        if [ ! -f api.txt ]; then
          echo "âŒ api.txt æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ­£åœ¨åˆ›å»ºç¤ºä¾‹æ–‡ä»¶..."
          cat > api.txt << 'APIEOF'
        # API åˆ—è¡¨é…ç½®æ–‡ä»¶
        # æ¯è¡Œä¸€ä¸ª API åœ°å€ï¼Œ# å¼€å¤´çš„è¡Œä¸ºæ³¨é‡Š
        # 
        # CloudFlare IP ä¼˜é€‰ API
        https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/bestproxy.txt
        https://raw.githubusercontent.com/ymyuuu/IPDB/refs/heads/main/bestcf.txt
        https://ip.164746.xyz/ipTop10.html
        https://raw.githubusercontent.com/ZhiXuanWang/cf-speed-dns/refs/heads/main/ipTop10.html
        https://vps789.com/public/sum/cfIpApi
        # https://www.wetest.vip/api/cf2dns/get_cloudflare_ip&type=v4&key=o1zrmHAF
        https://raw.githubusercontent.com/cmliu/WorkerVless2sub/main/addressesapi.txt
        https://addressesapi.090227.xyz/CloudFlareYes
        https://addressesapi.090227.xyz/ip.164746.xyz
        APIEOF
          echo "âœ… å·²åˆ›å»ºç¤ºä¾‹ api.txt æ–‡ä»¶"
        fi
        echo "ðŸ“‹ API åˆ—è¡¨å†…å®¹ï¼š"
        cat api.txt

    - name: Run IP connectivity test
      run: |
        python test_ip.py

    - name: Check if ip.txt exists and has valid data
      id: check_file
      run: |
        if [ -f ip.txt ]; then
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å®žé™…çš„IPæ•°æ®ï¼ˆæŽ’é™¤æ³¨é‡Šè¡Œï¼‰
          valid_lines=$(grep -v '^#' ip.txt | grep -E '^\s*[0-9]+\.[0-9]+\.[0-9]+\.[0-9]+' | wc -l)
          
          if [ "$valid_lines" -gt 0 ]; then
            echo "file_exists=true" >> $GITHUB_OUTPUT
            echo "âœ… ip.txt æ–‡ä»¶å·²ç”Ÿæˆï¼ŒåŒ…å« $valid_lines ä¸ªæœ‰æ•ˆ IP"
            echo "ip_count=$valid_lines" >> $GITHUB_OUTPUT
          else
            echo "file_exists=false" >> $GITHUB_OUTPUT
            echo "âš ï¸  ip.txt æ–‡ä»¶å·²ç”Ÿæˆï¼Œä½†æ²¡æœ‰æœ‰æ•ˆçš„ IP æ•°æ®"
            echo "ip_count=0" >> $GITHUB_OUTPUT
          fi
          
          echo "ðŸ“„ æ–‡ä»¶å†…å®¹é¢„è§ˆ:"
          head -n 30 ip.txt
        else
          echo "file_exists=false" >> $GITHUB_OUTPUT
          echo "ip_count=0" >> $GITHUB_OUTPUT
          echo "âŒ ip.txt æ–‡ä»¶æœªç”Ÿæˆ"
        fi

    - name: Create Release
      if: steps.check_file.outputs.file_exists == 'true'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ github.run_number }}-${{ github.run_id }}
        name: IP List ${{ github.run_number }} - ${{ steps.check_file.outputs.ip_count }} IPs (ä¸‰ç½‘å…¨é€š)
        body: |
          ## ðŸ“‹ IP ä¸‰ç½‘è¿žé€šæ€§æµ‹è¯•ç»“æžœ
          
          **æµ‹è¯•æ—¶é—´:** `${{ github.event.repository.updated_at }}`  
          **è¿è¡Œç¼–å·:** #${{ github.run_number }}  
          **ä¸‰ç½‘å…¨é€š IP:** ${{ steps.check_file.outputs.ip_count }} ä¸ª
          
          ### ðŸ“Š æµ‹è¯•è¯´æ˜Ž
          - âœ… æ‰€æœ‰ IP å‡é€šè¿‡ä¸­å›½ä¸‰å¤§è¿è¥å•†è¿žé€šæ€§æµ‹è¯•
          - ðŸŒ **ä¸­å›½ç”µä¿¡** âœ“ | **ä¸­å›½è”é€š** âœ“ | **ä¸­å›½ç§»åŠ¨** âœ“
          - ðŸ“ åŒ…å«è¯¦ç»†åœ°ç†ä½ç½®ä¿¡æ¯ï¼ˆå›½å®¶-åŸŽå¸‚/åœ°åŒºï¼‰
          - ðŸ“ æ ¼å¼: `IP:ç«¯å£#å›½å®¶-åœ°åŒº`
          - ðŸ”„ æ¯å¤©åŒ—äº¬æ—¶é—´å‡Œæ™¨ 3 ç‚¹è‡ªåŠ¨æ›´æ–°
          
          ### ðŸŽ¯ è´¨é‡ä¿è¯
          - åªä¿ç•™**ä¸‰ç½‘å…¨é€š**çš„ IP åœ°å€
          - æ¯ä¸ª IP éƒ½ç»è¿‡ç”µä¿¡ã€è”é€šã€ç§»åŠ¨ç½‘ç»œéªŒè¯
          - ç¡®ä¿å…¨å›½ç”¨æˆ·éƒ½èƒ½æ­£å¸¸è®¿é—®
          
          ### ðŸ“¥ ä½¿ç”¨æ–¹æ³•
          1. ä¸‹è½½ `ip.txt` æ–‡ä»¶
          2. æŒ‰ç…§æ ¼å¼ä½¿ç”¨å…¶ä¸­çš„ IP åœ°å€
          3. æ¯ä¸ª IP éƒ½å·²éªŒè¯å¯è¿žæŽ¥
          
          ### âš™ï¸ API æ¥æº
          IP æ•°æ®æ¥è‡ª `api.txt` æ–‡ä»¶ä¸­é…ç½®çš„ API æŽ¥å£
          
          ---
          *æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ ðŸ¤–*
        files: |
          ip.txt
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Keep only latest 5 releases
      if: steps.check_file.outputs.file_exists == 'true'
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const releases = await github.rest.repos.listReleases({
            owner: context.repo.owner,
            repo: context.repo.repo,
            per_page: 100
          });
          
          const sortedReleases = releases.data.sort((a, b) => 
            new Date(b.created_at) - new Date(a.created_at)
          );
          
          console.log(`Found ${sortedReleases.length} releases`);
          
          if (sortedReleases.length > 5) {
            for (let i = 5; i < sortedReleases.length; i++) {
              console.log(`Deleting release: ${sortedReleases[i].name} (${sortedReleases[i].tag_name})`);
              await github.rest.repos.deleteRelease({
                owner: context.repo.owner,
                repo: context.repo.repo,
                release_id: sortedReleases[i].id
              });
              
              // åŒæ—¶åˆ é™¤å¯¹åº”çš„ tag
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `tags/${sortedReleases[i].tag_name}`
                });
                console.log(`Deleted tag: ${sortedReleases[i].tag_name}`);
              } catch (error) {
                console.log(`Could not delete tag: ${sortedReleases[i].tag_name}`);
              }
            }
            console.log(`âœ… Cleaned up ${sortedReleases.length - 5} old releases`);
          } else {
            console.log('âœ… No cleanup needed');
          }
